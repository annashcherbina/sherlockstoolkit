<div>
    <% unless params[:failures] == [] %>
        <p>Insufficient panel data for <%= @failures.values.sort_by{ |e| e.to_i }.join(', ') %></p>
    <% end %>
</div>

<table class="pretty">
    <thead>
    <tr>
        <th>Person - Experiment</th>
        <th>Ancestry 1</th>
        <th>Ancestry 2</th>
        <th>Ancestry 3</th>
        <th>Ancestry 4</th>
    </tr>
    </thead>
    <tbody>
    <% @persons_ancestries_hash.sort_by{ |k, v| k.to_i }.each do |k, v| %>
        <tr>
            <td><%= k %></td>
            <% v.each do |ancestry| %>
                <td><%= "#{ancestry.percent}% #{@ethnicity_hash[ancestry.ethnicity_id].name}" %></td>
            <% end %>
        </tr>
    <% end %>
    </tbody>
</table>

<%= render(partial: 'layouts/parameters', locals: {parameters: @parameters} ) unless @parameters.empty? %>

<div id="container" style="position: relative; width: 1500px; height: 900px;"></div>

<%# invokes the javascript DataMaps module to display a map customized by the parameters
@fills_array_string and @all_bubbles generated by the controller %>
<%= javascript_tag do %>
    function loadAncestryMap(){
        var map = new Datamap({
        element: document.getElementById('container'),
        projection: 'mercator',
        fills: <%= raw(@datamap_fills) %>
        });

        map.legend();

        map.bubbles(<%= raw(@datamap_bubbles) %>,
        {
        popupTemplate: function(geo, data) {
        return '<div class="hoverinfo">Person ' + data.id_code + '<br>' + data.ethnicity + ' ancestry ' + '<br>' + data.radius + '% likelihood.</div>'
        }
        });

        <%# if there is more than one sample mapped, then you can click through to the mapping of that singular sample on the legend %>
        <% if @successes.size > 1 %>
            legend_hash = <%= raw(@legend_json) %>
            legend_array = $("div.datamaps-legend dt")

            //replaces the text in the legend with a hyperlink to the individualized map
            legend_array.each( function(){
            key = $(this).html();
            key = key.substring(0, key.length - 2);
            value = legend_hash[key];

            if(value){
                aTag = "<a href='/ancestries/map?attachment_id=" + <%= params[:attachment_id] %> + "&successes%5B%5D=" + value + "'>" + key + "</a>:"
            $(this).html(aTag);
            }
            });
        <% end %>
    };
<% end %>


<% content_for :javascripts do %>
    <%= javascript_include_tag 'ancestries' %>
<% end %>